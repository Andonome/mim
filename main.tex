\documentclass[a4paper,openany]{book}

\usepackage{config/bind}
\input{glossary.tex}

\hypersetup{pdfinfo={
Title={Missions in Maitavale},
Subject={TTRPG},
Keywords={TTRPG,RPG,roleplaying}
}}

\settoggle{intro}{false}
\externalReferent{core}
\externalReferent{stories}
\externalReferent{judgement}

\input{commands.tex}

\begin{document}

\frontpage{Missions in Maitavale}%
  {A \glsfmttext{campaign} of karma}%

\glsunsetall
\input{intro.tex}

\printglossary[
  style=topicmcols,
]

\printglossary[
  type=mech,
  style=topicmcols,
  nonumberlist,
  ]

\printglossary[
  type=symbols,
  ]

%%%%%%%%%%%%%%%%%%%% Plots & Threads

\mainmatter

\declareRegions{town,Roads,Forest}

\input{plots.tex}

\glsresetall
\clearpage

%%%%%%%%%%%%%%%%%%%% Side Quests

\chapter{Tangled Threads}
  \epigraph{He attacked everything in life with a mix of extraordinary genius and na\"ive incompetence, and it was often difficult to tell which was which.}{Douglas Adams}
\label{threads}

\section{Thriving in the Dreich}
\begin{multicols}{2}
\ifnum\value{cycle}>2
  \input{threads/spider.tex}
  \input{threads/wolves.tex}
  \input{threads/entitlement.tex}
  \input{threads/hunger.tex}
\else
  \input{threads/wolves.tex}
  \input{threads/hunger.tex}
  \input{threads/entitlement.tex}
  \input{threads/spider.tex}
\fi
\end{multicols}

\section{Stoic in the Drizzle}
\begin{multicols}{2}
\input{raising/ale.tex}
\needspace{10\baselineskip}
\input{raising/prince.tex}
\input{raising/sewer_bandits.tex}
\end{multicols}

\section{Alive in the Eye of the Storm}

\begin{multicols}{2}
\input{storm/demilich.tex}
\input{storm/new_wardens.tex}
\end{multicols}

\section{Interruptions}

\input{tailend/intro.tex}
\begin{multicols}{2}
\input{tailend/town.tex}
\input{tailend/forest.tex}
\end{multicols}

\stopcontents[segments]

%%%%%%%%%%%%%%%%%%%% Forest

\glsresetall

%%%%%%%%%%%%%%%%%%
\label{forestStart}
\input{forest/intro.tex}
\input{forest/camp.tex}
\input{forest/basement.tex}
\input{forest/green_tower.tex}
\input{forest/shadow_gate.tex}
\input{forest/old_temple.tex}
\input{forest/bandit_bailey.tex}
\label{forestEnd}

%%%%%%%%%%%%%%%%%%%% Roads

\input{config/markets/commands.tex}

\Repeat{5}{%
  \advanceTheDate[30]%
  \handout{config/markets/bailey}%
}

\handout{roads_broch_handout}

\Repeat{2}{%
  \advanceTheDate[30]%
  \handout{lochside_handout}
}
\setCycle{\month}{\day}

\glsresetall

\label{roadsStart}
\input{roads/intro.tex}
\input{roads/broch.tex}
\input{roads/gorge.tex}
\input{roads/lochside.tex}
\input{roads/redfall.tex}
\input{roads/redfall_fallen.tex}
\label{roadsEnd}

%%%%%%%%%%%%%%%%%% Town

\renewcommand\marketDoula{\Glsentrytext{forestpriest}}
\renewcommand\marketBard{\Glsentrytext{warningbard}}
\renewcommand\marketTavernOne{\Glsentrytext{pig}\renewcommand\npcsymbol{\glsentrysymbol{templeOfSickness}}}
\renewcommand\marketInnTwo{\Glsentrytext{whitehorse} Inn}
\renewcommand\marketMixer{\Glsentrytext{healerLeader}}
\renewcommand\marketFence{\Glsentrytext{sewerking}}
\renewcommand\marketWeaponsSeller{\Glsentrytext{captain}}

\Repeat{3}{%
  \advanceTheDate[30]%
  \handout{config/markets/town}
}
\setCycle{\month}{\day}

\handout{maps_handouts}

\handout{animal_handouts}

\handout{service_handouts}

\glsresetall
\label{townStart}
\input{town/ground.tex}
\input{town/station_dungeon.tex}
\input{town/pig.tex}
\input{town/sewers.tex}
\input{town/oolery.tex}
\label{townEnd}

%%%%%%%%%%%% Appendix

\startappendix

\input{appendix.tex}

\end{document}
